#include <GinSing.h>
#include <MIDI.h>

#include <U8glib.h>

#include "Defenitions.h"
#include "KanaTable.h"
#include "GLCDMan.h"

#define rcvPin 4
#define sndPin 3
#define ovfPin 2

GinSing GS;
GinSingVoice * voice = 0x0;

GLCDManager glcd_man;

void setup ()
{
  pinMode(22, OUTPUT);
  MIDI.begin(MIDI_CHANNEL_OMNI);
  MIDI.setHandleNoteOn(midi_note_handle);
  GS.begin(rcvPin , sndPin , ovfPin);
  voice = GS.getVoice();
  voice->begin();

}

void jpSpeakKana(KanaTable::Kana kana, GSNote note)
{
//  voice->setBlendSpeed(0.2f);
//  voice->setDelay(0.02f);
  voice->setNote(note);
  voice->speak(GSKanaMap::KanaMap[kana]);
}

void endSpeak()
{
  GSAllophone phrase[] = {_PA1, _ENDPHRASE};
  voice->speak(phrase);
}

KanaTable::Kana phrase[] = {
              KanaTable::_NA,
              KanaTable::_GA,
              KanaTable::_RE,
              KanaTable::_TE,
              KanaTable::_KU,
              KanaTable::_TO,
              KanaTable::_KI,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_KA,
              KanaTable::_DE,
              KanaTable::_DE,
              KanaTable::_MO,
              KanaTable::_KE,
              KanaTable::_DA,
              KanaTable::_RU,
              KanaTable::_SA,
              KanaTable::_GA,
              KanaTable::_HO,
              KanaTable::_RA,
              KanaTable::_GU,
              KanaTable::_RU,
              KanaTable::_GU,
              KanaTable::_RU,
              KanaTable::_MA,
              KanaTable::_WA,
              KanaTable::_TE,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_KA,
              KanaTable::_RA,
              KanaTable::_HA,
              KanaTable::_NA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_KO,
              KanaTable::_KO,
              KanaTable::_RO,
              KanaTable::_MO,
              KanaTable::_MI,
              KanaTable::_E,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_WA,
              KanaTable::_SO,
              KanaTable::_U,
              KanaTable::_SHI,
              KanaTable::_RA,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_KA,
              KanaTable::_RA,
              KanaTable::_U,
              KanaTable::_GO,
              KanaTable::_KU,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_MO,
              KanaTable::_NA,
              KanaTable::_KU,
              KanaTable::_TO,
              KanaTable::_KI,
              KanaTable::_NO,
              KanaTable::_SU,
              KanaTable::_KI,
              KanaTable::_MA,
              KanaTable::_NI,
              KanaTable::_NA,
              KanaTable::_GA,
              KanaTable::_SA,
              KanaTable::_RE,
              KanaTable::_TSU,
              KanaTable::_ZU,
              KanaTable::_KE,
              KanaTable::_TE,
              KanaTable::_SHI,
              KanaTable::_RA,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_WA,
              KanaTable::_MA,
              KanaTable::_WA,
              KanaTable::_RI,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_NA,
              KanaTable::_DO,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_WA,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_SO,
              KanaTable::_RE,
              KanaTable::_DA,
              KanaTable::_KE,
              KanaTable::_YU,
              KanaTable::_ME,
              KanaTable::_MI,
              KanaTable::_TE,
              KanaTable::_RU,
              KanaTable::_NA,
              KanaTable::_NI,
              KanaTable::_MO,
              KanaTable::_MI,
              KanaTable::_TE,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_KA,
              KanaTable::_TA,
              KanaTable::_RU,
              KanaTable::_MO,
              KanaTable::_MU,
              KanaTable::_DA,
              KanaTable::_NA,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_BA,
              KanaTable::_KA,
              KanaTable::_NA,
              KanaTable::_SHI,
              KanaTable::_MU,
              KanaTable::_NA,
              KanaTable::_N,
              KanaTable::_TE,
              KanaTable::_TSU,
              KanaTable::_KA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_DA,
              KanaTable::_KE,
              KanaTable::_YO,
              KanaTable::_NA,
              KanaTable::_NI,
              KanaTable::_MO,
              KanaTable::_KA,
              KanaTable::_N,
              KanaTable::_JI,
              KanaTable::_ZU,
              KanaTable::_SU,
              KanaTable::_GO,
              KanaTable::_SE,
              KanaTable::_BA,
              KanaTable::_I,
              KanaTable::_I,
              KanaTable::_NO,
              KanaTable::_TO,
              KanaTable::_MA,
              KanaTable::_DO,
              KanaTable::_U,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_BA,
              KanaTable::_A,
              KanaTable::_TA,
              KanaTable::_E,
              KanaTable::_RA,
              KanaTable::_RE,
              KanaTable::_TE,
              KanaTable::_MO,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_KO,
              KanaTable::_RO,
              KanaTable::_TA,
              KanaTable::_DA,
              KanaTable::_U,
              KanaTable::_WA,
              KanaTable::_NO,
              KanaTable::_SO,
              KanaTable::_RA,
              KanaTable::_MO,
              KanaTable::_SHI,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_KA,
              KanaTable::_RA,
              KanaTable::_U,
              KanaTable::_GO,
              KanaTable::_KU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_BA,
              KanaTable::_SU,
              KanaTable::_BE,
              KanaTable::_TE,
              KanaTable::_KA,
              KanaTable::_E,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_KU,
              KanaTable::_RO,
              KanaTable::_NI,
              KanaTable::_SU,
              KanaTable::_RU,
              KanaTable::_KO,
              KanaTable::_N,
              KanaTable::_NA,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_NI,
              KanaTable::_MI,
              KanaTable::_RA,
              KanaTable::_I,
              KanaTable::_WA,
              KanaTable::_A,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_N,
              KanaTable::_NA,
              KanaTable::_SE,
              KanaTable::_KA,
              KanaTable::_I,
              KanaTable::_NI,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_NI,
              KanaTable::_I,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_I,
              KanaTable::_MA,
              KanaTable::_SE,
              KanaTable::_TSU,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_NO,
              KanaTable::_I,
              KanaTable::_MA,
              KanaTable::_KA,
              KanaTable::_NA,
              KanaTable::_SHI,
              KanaTable::_I,
              KanaTable::_NO,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_MO,
              KanaTable::_WA,
              KanaTable::_KA,
              KanaTable::_RA,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_MA,
              KanaTable::_MA,
              KanaTable::_A,
              KanaTable::_YU,
              KanaTable::_MU,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_SA,
              KanaTable::_E,
              KanaTable::_TSU,
              KanaTable::_KA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_DA,
              KanaTable::_KE,
              KanaTable::_YO,
              KanaTable::_HI,
              KanaTable::_TO,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_NA,
              KanaTable::_DO,
              KanaTable::_SHI,
              KanaTable::_RI,
              KanaTable::_MO,
              KanaTable::_SHI,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_WA,
              KanaTable::_KO,
              KanaTable::_N,
              KanaTable::_NA,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_MO,
              KanaTable::_KA,
              KanaTable::_WA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_MO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_MO,
              KanaTable::_SHI,
              KanaTable::_KA,
              KanaTable::_WA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_SHI,
              KanaTable::_RO,
              KanaTable::_NI,
              KanaTable::_NA,
              KanaTable::_RU,
              KanaTable::_NA,
              KanaTable::_GA,
              KanaTable::_RE,
              KanaTable::_TE,
              KanaTable::_KU,
              KanaTable::_TO,
              KanaTable::_KI,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_KA,
              KanaTable::_DE,
              KanaTable::_DE,
              KanaTable::_MO,
              KanaTable::_KE,
              KanaTable::_DA,
              KanaTable::_RU,
              KanaTable::_SA,
              KanaTable::_GA,
              KanaTable::_HO,
              KanaTable::_RA,
              KanaTable::_GU,
              KanaTable::_RU,
              KanaTable::_GU,
              KanaTable::_RU,
              KanaTable::_MA,
              KanaTable::_WA,
              KanaTable::_TE,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_KA,
              KanaTable::_RA,
              KanaTable::_HA,
              KanaTable::_NA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_KO,
              KanaTable::_KO,
              KanaTable::_RO,
              KanaTable::_MO,
              KanaTable::_MI,
              KanaTable::_E,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_WA,
              KanaTable::_SO,
              KanaTable::_U,
              KanaTable::_SHI,
              KanaTable::_RA,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_KA,
              KanaTable::_RA,
              KanaTable::_U,
              KanaTable::_GO,
              KanaTable::_KU,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_MO,
              KanaTable::_NA,
              KanaTable::_KU,
              KanaTable::_TO,
              KanaTable::_KI,
              KanaTable::_NO,
              KanaTable::_SU,
              KanaTable::_KI,
              KanaTable::_MA,
              KanaTable::_NI,
              KanaTable::_NA,
              KanaTable::_GA,
              KanaTable::_SA,
              KanaTable::_RE,
              KanaTable::_TSU,
              KanaTable::_ZU,
              KanaTable::_KE,
              KanaTable::_TE,
              KanaTable::_SHI,
              KanaTable::_RA,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_WA,
              KanaTable::_MA,
              KanaTable::_WA,
              KanaTable::_RI,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_NA,
              KanaTable::_DO,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_WA,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_SO,
              KanaTable::_RE,
              KanaTable::_DA,
              KanaTable::_KE,
              KanaTable::_YU,
              KanaTable::_ME,
              KanaTable::_MI,
              KanaTable::_TE,
              KanaTable::_RU,
              KanaTable::_NA,
              KanaTable::_NI,
              KanaTable::_MO,
              KanaTable::_MI,
              KanaTable::_TE,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_KA,
              KanaTable::_TA,
              KanaTable::_RU,
              KanaTable::_MO,
              KanaTable::_MU,
              KanaTable::_DA,
              KanaTable::_NA,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_BA,
              KanaTable::_KA,
              KanaTable::_NA,
              KanaTable::_SHI,
              KanaTable::_MU,
              KanaTable::_NA,
              KanaTable::_N,
              KanaTable::_TE,
              KanaTable::_TSU,
              KanaTable::_KA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_DA,
              KanaTable::_KE,
              KanaTable::_YO,
              KanaTable::_NA,
              KanaTable::_NI,
              KanaTable::_MO,
              KanaTable::_KA,
              KanaTable::_N,
              KanaTable::_JI,
              KanaTable::_ZU,
              KanaTable::_SU,
              KanaTable::_GO,
              KanaTable::_SE,
              KanaTable::_BA,
              KanaTable::_I,
              KanaTable::_I,
              KanaTable::_NO,
              KanaTable::_TO,
              KanaTable::_MA,
              KanaTable::_DO,
              KanaTable::_U,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_BA,
              KanaTable::_A,
              KanaTable::_TA,
              KanaTable::_E,
              KanaTable::_RA,
              KanaTable::_RE,
              KanaTable::_TE,
              KanaTable::_MO,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_KO,
              KanaTable::_RO,
              KanaTable::_TA,
              KanaTable::_DA,
              KanaTable::_U,
              KanaTable::_WA,
              KanaTable::_NO,
              KanaTable::_SO,
              KanaTable::_RA,
              KanaTable::_MO,
              KanaTable::_SHI,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_KA,
              KanaTable::_RA,
              KanaTable::_U,
              KanaTable::_GO,
              KanaTable::_KU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_BA,
              KanaTable::_SU,
              KanaTable::_BE,
              KanaTable::_TE,
              KanaTable::_KA,
              KanaTable::_E,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_KU,
              KanaTable::_RO,
              KanaTable::_NI,
              KanaTable::_SU,
              KanaTable::_RU,
              KanaTable::_MU,
              KanaTable::_DA,
              KanaTable::_NA,
              KanaTable::_JI,
              KanaTable::_KA,
              KanaTable::_N,
              KanaTable::_NI,
              KanaTable::_MI,
              KanaTable::_RA,
              KanaTable::_I,
              KanaTable::_WA,
              KanaTable::_A,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_N,
              KanaTable::_NA,
              KanaTable::_TO,
              KanaTable::_KO,
              KanaTable::_RO,
              KanaTable::_NI,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_NI,
              KanaTable::_I,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_O,
              KanaTable::_I,
              KanaTable::_I,
              KanaTable::_TA,
              KanaTable::_I,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_BA,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_BA,
              KanaTable::_NI,
              KanaTable::_SU,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_RO,
              KanaTable::_KU,
              KanaTable::_DE,
              KanaTable::_NA,
              KanaTable::_SHI,
              KanaTable::_KO,
              KanaTable::_N,
              KanaTable::_NA,
              KanaTable::_TO,
              KanaTable::_KO,
              KanaTable::_RO,
              KanaTable::_NI,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_WA,
              KanaTable::_I,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_N,
              KanaTable::_NA,
              KanaTable::_JI,
              KanaTable::_KA,
              KanaTable::_N,
              KanaTable::_NI,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_WA,
              KanaTable::_I,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_N,
              KanaTable::_NA,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_MO,
              KanaTable::_KA,
              KanaTable::_WA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_MO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_MO,
              KanaTable::_SHI,
              KanaTable::_KA,
              KanaTable::_WA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_SHI,
              KanaTable::_RO,
              KanaTable::_NI,
              KanaTable::_NA,
              KanaTable::_RU,
              KanaTable::_I,
              KanaTable::_MA,
              KanaTable::_YU,
              KanaTable::_ME,
              KanaTable::_MI,
              KanaTable::_TE,
              KanaTable::_RU,
              KanaTable::_NA,
              KanaTable::_NI,
              KanaTable::_MO,
              KanaTable::_MI,
              KanaTable::_TE,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_KA,
              KanaTable::_TA,
              KanaTable::_RU,
              KanaTable::_MO,
              KanaTable::_MU,
              KanaTable::_DA,
              KanaTable::_NA,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_BA,
              KanaTable::_KA,
              KanaTable::_NA,
              KanaTable::_SHI,
              KanaTable::_MU,
              KanaTable::_NA,
              KanaTable::_N,
              KanaTable::_TE,
              KanaTable::_TSU,
              KanaTable::_KA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_DA,
              KanaTable::_KE,
              KanaTable::_YO,
              KanaTable::_NA,
              KanaTable::_NI,
              KanaTable::_MO,
              KanaTable::_KA,
              KanaTable::_N,
              KanaTable::_JI,
              KanaTable::_ZU,
              KanaTable::_SU,
              KanaTable::_GO,
              KanaTable::_SE,
              KanaTable::_BA,
              KanaTable::_I,
              KanaTable::_I,
              KanaTable::_NO,
              KanaTable::_TO,
              KanaTable::_MA,
              KanaTable::_DO,
              KanaTable::_U,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_BA,
              KanaTable::_A,
              KanaTable::_TA,
              KanaTable::_E,
              KanaTable::_RA,
              KanaTable::_RE,
              KanaTable::_TE,
              KanaTable::_MO,
              KanaTable::_JI,
              KanaTable::_BU,
              KanaTable::_N,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_KO,
              KanaTable::_RO,
              KanaTable::_TA,
              KanaTable::_DA,
              KanaTable::_U,
              KanaTable::_WA,
              KanaTable::_NO,
              KanaTable::_SO,
              KanaTable::_RA,
              KanaTable::_MO,
              KanaTable::_SHI,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_KA,
              KanaTable::_RA,
              KanaTable::_U,
              KanaTable::_GO,
              KanaTable::_KU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_BA,
              KanaTable::_SU,
              KanaTable::_BE,
              KanaTable::_TE,
              KanaTable::_KA,
              KanaTable::_E,
              KanaTable::_RU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_KU,
              KanaTable::_RO,
              KanaTable::_NI,
              KanaTable::_SU,
              KanaTable::_RU,
              KanaTable::_U,
              KanaTable::_GO,
              KanaTable::_KU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_BA,
              KanaTable::_U,
              KanaTable::_GO,
              KanaTable::_KU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_BA,
              KanaTable::_SU,
              KanaTable::_BE,
              KanaTable::_TE,
              KanaTable::_KO,
              KanaTable::_WA,
              KanaTable::_SU,
              KanaTable::_WA,
              KanaTable::_SU,
              KanaTable::_BE,
              KanaTable::_TE,
              KanaTable::_KO,
              KanaTable::_WA,
              KanaTable::_SU,
              KanaTable::_WA,
              KanaTable::_KA,
              KanaTable::_NA,
              KanaTable::_SHI,
              KanaTable::_MU,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_BA,
              KanaTable::_KA,
              KanaTable::_NA,
              KanaTable::_SHI,
              KanaTable::_MU,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_BA,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_KO,
              KanaTable::_RO,
              KanaTable::_SHI,
              KanaTable::_RO,
              KanaTable::_KU,
              KanaTable::_KA,
              KanaTable::_WA,
              KanaTable::_RE,
              KanaTable::_RU,
              KanaTable::_A,
              KanaTable::_NA,
              KanaTable::_TA,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_MO,
              KanaTable::_WA,
              KanaTable::_TA,
              KanaTable::_SHI,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_MO,
              KanaTable::_SU,
              KanaTable::_BE,
              KanaTable::_TE,
              KanaTable::_NO,
              KanaTable::_KO,
              KanaTable::_TO,
              KanaTable::_MO,
              KanaTable::_MA,
              KanaTable::_DA,
              KanaTable::_SHI,
              KanaTable::_RA,
              KanaTable::_NA,
              KanaTable::_I,
              KanaTable::_NO,
              KanaTable::_O,
              KanaTable::_MO,
              KanaTable::_I,
              KanaTable::_MA,
              KanaTable::_BU,
              KanaTable::_TA,
              KanaTable::_WO,
              KanaTable::_A,
              KanaTable::_KE,
              KanaTable::_TA,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_BA,
              KanaTable::_SU,
              KanaTable::_BE,
              KanaTable::_TE,
              KanaTable::_KO,
              KanaTable::_WA,
              KanaTable::_SU,
              KanaTable::_NO,
              KanaTable::_NA,
              KanaTable::_RA,
              KanaTable::_KU,
              KanaTable::_RO,
              KanaTable::_NI,
              KanaTable::_NA,
              KanaTable::_RE,
              KanaTable::_NULL
            };

int phrase_pos = 0;
int notes_on = 0;

void midi_note_handle(byte channel, byte pitch, byte velocity)
{
  if(velocity == 0)
  {
    notes_on--;
    if(notes_on == 0) {
      endSpeak();
    }
  }
  else
  {
    notes_on++;
    KanaTable::Kana kana = phrase[phrase_pos];
    phrase_pos++;
    if(phrase[phrase_pos] == KanaTable::_NULL) phrase_pos = 0;
    GSNote note = GS_MIDINotes[pitch];
    jpSpeakKana(kana, note);
  }
}

long last_hb = 0;
boolean hb_state = false;

void heartbeat()
{
  int heartbeat_delay = 100;
  long current_time = millis();
  long delta_t = current_time - last_hb;
  if(delta_t > heartbeat_delay)
  {
    hb_state = !hb_state;
    int led_state = 0;
    if(hb_state) led_state = 1;
    digitalWrite(22, led_state);
    last_hb = current_time;
  }
}

void loop()
{
  heartbeat();
  MIDI.read();
  glcd_man.u8g.firstPage();  
  do {
    glcd_man.draw();
    KanaTable::Kana displayPhraseKana[7];
    for(int i=0; i<7; i++)
    {
      int index = phrase_pos + i;
      displayPhraseKana[i] = phrase[index];
    }
    glcd_man.drawKanaBuffer(displayPhraseKana, notes_on);
  } while(glcd_man.u8g.nextPage());
}

